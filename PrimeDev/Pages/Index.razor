@page "/"

@inject PrimeManager manager

<MudGrid Spacing="5" Justify="Justify.Center">
    <MudItem>
        <MudPaper Style="padding: 15pt; padding-bottom:5pt;" Class="d-flex flex-column align-center justify-center mud-width-full py-8">
               @if (!manager.IsInitialized)
                {
                    <MudText Typo="Typo.h6" Align="Align.Center">It seems you haven't connected your HP Prime Yet!</MudText>
                    <MudText Typo="Typo.subtitle1" Align="Align.Center">Click the connection button at the top right corner of this page to start the discovery and connection.</MudText>
                }
                else
                {

                       
                            <MudText Typo="Typo.h6" Align="Align.Center">Initialized!</MudText>
                            <MudText Typo="Typo.subtitle1" Align="Align.Center">Press the following button to initialize a connection test</MudText>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="SendTest" Style="margin-top: 15pt;">Send Test!</MudButton>
                 
                     
                }
        </MudPaper>
    </MudItem>
    <MudItem xs=12>
        @foreach(var msg in messages)
        {
            <MudText Typo="Typo.subtitle1" Align="Align.Left">Message: @msg</MudText>
        }
    </MudItem>

   
</MudGrid>

@code{
    private PrimeCalculator prime;

    private List<string> messages = new List<string>();

    public async Task SendTest()
    {
        Console.WriteLine("Sending Test packet!");
        prime = manager.GetCalculator();
        //prime.Connected += CurrentPrime_Connected;
        //prime.DataReceived += CurrentPrime_Received;
        //prime.ChatMessageReceived += CurrentPrime_Message;
    }

    async void CurrentPrime_Connected(object? sender, EventArgs e)
    {
        Console.WriteLine("[Index.rzr] - Prime is connected!");
        //await prime.SendChatMessage("Test message from WebPrime!");
    }

    void CurrentPrime_Received(object? sender, PrimeWeb.DataReceivedEventArgs e)
    {
        Console.WriteLine("Prime is received data!");
        var tet = new PrimeUsbData(e.Data);

        Console.WriteLine(tet);
    }

    void CurrentPrime_Message(object? sender, PrimeWeb.MessageReceivedEventArgs e)
    {
        messages.Add((DateTime.Now.ToShortTimeString() + "\t-\t" +  e.Message));
     
        StateHasChanged();
    }


    
    protected override void OnInitialized()
    {
        manager.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        manager.OnChange -= StateHasChanged;
    }

}